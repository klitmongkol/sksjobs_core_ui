# ‡πÉ‡∏ä‡πâ Image ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ PHP
FROM php:8.2-fpm

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
RUN apt-get update && apt-get install -y \
    build-essential \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
    curl \
    git \
    libzip-dev \
    # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Node.js v20 ‡πÅ‡∏•‡∏∞ NPM
    # ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á version mismatch ‡∏Å‡∏±‡∏ö Vite
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install pdo pdo_mysql mbstring zip gd

# üåüüåüüåü ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç PHP INI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CLI/FPM ‡πÄ‡∏õ‡πá‡∏ô 500M üåüüåüüåü
# ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .ini ‡πÉ‡∏ô conf.d ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏≤‡∏ß‡∏£
RUN echo "post_max_size = 500M" > /usr/local/etc/php/conf.d/custom-upload.ini \
    && echo "upload_max_filesize = 500M" >> /usr/local/etc/php/conf.d/custom-upload.ini \
    && echo "memory_limit = 512M" >> /usr/local/etc/php/conf.d/custom-upload.ini \
    && echo "max_execution_time = 300" >> /usr/local/etc/php/conf.d/custom-upload.ini \
    && echo "date.timezone = Asia/Bangkok" >> /usr/local/etc/php/conf.d/custom-upload.ini

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

WORKDIR /var/www

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
COPY . .

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á PHP ‡πÅ‡∏•‡∏∞ Node.js dependencies
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏±‡∏ô npm install ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á node_modules ‡πÉ‡∏´‡πâ
RUN composer install
RUN npm install

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå
RUN chown -R www-data:www-data /var/www

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Port ‡∏ó‡∏µ‡πà Container ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
EXPOSE 8000

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Container ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8000"]
